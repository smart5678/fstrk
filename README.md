# Шлюз 
#### с дедублицикацией и возможностью тротлинга входящих запросов

### Настройки
TTL кэша дедубликаиции устанавливается через `DEFAULT_THROTTLE_RATES` в `project/settings.py`

Используется механизм тротлинга Django. Входящие запросы хэшируются на основе содержимого и помещаются в кэш, на основе которого идентифицируются последующие запросы и отбрасываются при повторении.
В отличие от реализации Django `DEFAULT_THROTTLE_RATES` разрешается только один запрос в интервал времени. `количество/время` делит единицу времени на указанное количество запросов. Интервал считается в секундах, поэтому для `/sec` (некритично для задачи) будет разрешать 1 запрос.

Для недублирующихся запросов создается задача в Celery `gateway.tasks.proxy_request` которая проксирует запросы. В декораторе таска через `rate_limit` по сути настраивается RPS с которым запросы передаются на конечный сервер.

В `.env` указывается сервер получатель `RECEIVER_URL`

### Установка
Зависимости:
```bash
python -m venv venv
source ./venv/bin/activate
pip install -r requirements.txt
```
### Запуск
Количество воркеров указываем соответственно требованиям

Приложение:
```bash
gunicorn --workers=1 'project.wsgi'
```

Celery worker
```bash
celery -A project.celery_app worker -l info -c 1
```

### Тесты
Результаты нагрузочного тестирования:
```bash
locust -f tests/locust.py 
```
![img](tests/Снимок%20экрана.png)

Функциональные тесты:
```bash
pytest -v
```